  /** for serialization */
	package mainpak;

import java.awt.BorderLayout;
import java.awt.Component;
import java.awt.GridLayout;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.WindowAdapter;
import java.awt.event.WindowEvent;
import java.beans.PropertyChangeEvent;
import java.beans.PropertyChangeListener;
import java.io.InputStream;

import javax.swing.BorderFactory;
import javax.swing.ButtonGroup;
import javax.swing.JButton;
import javax.swing.JCheckBox;
import javax.swing.JFrame;
import javax.swing.JMenuItem;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JPopupMenu;
import javax.swing.JRadioButton;
import javax.swing.JScrollPane;
import javax.swing.JTabbedPane;
import javax.swing.JTable;
import javax.swing.JTextArea;
import javax.swing.table.AbstractTableModel;
import javax.swing.table.DefaultTableModel;
import org.xml.sax.InputSource;

import Forecaster.src.app.App;

import weka.core.Attribute;
import weka.core.DenseInstance;
import weka.core.Instance;
import weka.core.Instances;
import weka.gui.beans.PluginManager;
import weka.gui.explorer.Explorer;
import weka.gui.explorer.ExplorerDefaults;
import weka.gui.explorer.Explorer.ExplorerPanel;
import weka.gui.explorer.Explorer.LogHandler;

import java.sql.DriverManager;
import java.sql.Connection;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Hashtable;
import java.util.Iterator;
import java.util.Map;
import java.util.List;
import java.util.Vector;

public class Explorer_for_selenga extends Explorer implements ActionListener {

		/**
		 * @param args
		 */
		protected JTabbedPane TabbedPane = new JTabbedPane();
		 protected Vector<ExplorerPanel> Panels = new Vector<ExplorerPanel>();
		static Statement stmt = null;
		static Connection c = null;
		static ResultSet rs;
		App forecast = new App();
		JPanel show_group_pokaz;
		JPanel button_panel = new JPanel();
		static Vector<Vector<String>> data = new Vector<Vector<String>>();
		JPanel show_data_type = new JPanel();
		JPanel show_year = new JPanel();
		JPanel show_sp = new JPanel();
		JPanel show_pokaz = new JPanel();
		JPanel select_data = new JPanel();
		JPanel edit_data = new JPanel();
		JPanel pokaz_and_buttons = new JPanel();
		HashSet<Integer> selected_pokaz = new HashSet(), selected_years = new HashSet(), selected_sps = new HashSet();
		HashMap<Integer, String> sp_id_name = new HashMap();
		Add_pokaz add_pokaz_form;
		int selected_year = -1 , selected_sp = -1;
		
		JRB_data_type by_year = new JRB_data_type(),by_sp = new JRB_data_type(),by_district = new JRB_data_type();
		
		JFrame frame = new JFrame(
				"Система ввода, хранения и анализа социо-экономических показателей Селенгинского района");
		JButton check_all = new JButton("Выбрать все");
		JButton show = new JButton("Загрузить выбранные атрибуты");
		JButton load_for_analyze = new JButton("Загрузить данные для анализа");
		JButton add_year = new JButton("Добавить год");
		JButton add_pokaz_button = new JButton("Добавить показатель");
		JButton delete_pokaz_button = new JButton("Удалить выбранные показатели");
		JPanel edit_buttons = new JPanel();
		JTable edit_table = new JTable();
		public DatabaseTableModel model=new DatabaseTableModel();

		public void connect() {
			try {

				Class.forName("org.postgresql.Driver");

			} catch (ClassNotFoundException e) {

				System.out.println("Where is your PostgreSQL JDBC Driver? "
						+ "Include in your library path!");
				e.printStackTrace();
				return;

			}

			System.out.println("PostgreSQL JDBC Driver Registered!");

			c = null;

			try {

				c = DriverManager.getConnection(
						"jdbc:postgresql://127.0.0.1:5432/selenga", "postgres",
						"178");

			} catch (SQLException e) {

				System.out.println("Connection Failed! Check output console");
				e.printStackTrace();
				return;

			}

			if (c != null) {
				System.out.println("You made it, take control your database now!");
			} else {
				System.out.println("Failed to make connection!");
			}
		}

		public class JRB extends JRadioButton {
			public int tag;
		}

		public class JCB extends JCheckBox {
			public int tag;
		}
		public class JRB_data_type extends JRadioButton {
			public int tag;
		}		
		public class JCB_sp extends JCheckBox {
			public int tag;
		}
		public class JCB_year extends JCheckBox {
			public int tag;
		}
		public class JRB_sp extends JRadioButton {
			public int tag;
		}
		public class JRB_year extends JRadioButton {
			public int tag;
		}

		public class DatabaseTableModel extends DefaultTableModel {
			public Map<Integer,Integer> row_pokaz_id = new HashMap();
			public Map<Integer,Integer> column_year = new HashMap();
			public boolean by_year = false;
			public int selected_year = -1;
			public int selected_sp = -1;
			public Connection conn;
			private static final long serialVersionUID = 1L;
			String[] columnNames = {}; 
			public HashSet<Integer> not_editable_row = new HashSet(); 

			public DatabaseTableModel(byte[] data, int cells) {
				super();
			}

			public DatabaseTableModel() {
				super();
			}
			@Override
			public void setValueAt(Object cell, int row, int column) {
				((Vector) dataVector.get(row)).set(column, cell);
				try {
					if (!cell.equals(""))
					{
						Statement st = conn.createStatement();
						int pokaz_id = row_pokaz_id.get(row);
						int year = column_year.get(column);
						if (by_year)
						{
							int data_type = year;
							ResultSet rs = st.executeQuery("select * from fact_table where pokaz = "+pokaz_id+" and year ="+selected_year+" and data_type = "+data_type);
							if (rs.next())
							{
								st.executeUpdate("update fact_table set value = "+cell+" where pokaz = "+pokaz_id+" and year ="+selected_year+" and data_type = "+data_type);
							}
							else
							{
								st.executeUpdate("insert into fact_table(year,pokaz,value,data_type) values ("+selected_year+","+pokaz_id+","+cell+","+data_type+")");
							}
						}
						else
						{
							if (selected_sp != -1)
							{
//								int data_type = year;
								ResultSet rs = st.executeQuery("select * from fact_table where pokaz = "+pokaz_id+" and year ="+year+" and data_type = "+selected_sp);
								if (rs.next())
								{
									st.executeUpdate("update fact_table set value = "+cell+" where pokaz = "+pokaz_id+" and year ="+year+" and data_type = "+selected_sp);
								}
								else
								{
									st.executeUpdate("insert into fact_table(year,pokaz,value,data_type) values ("+year+","+pokaz_id+","+cell+","+selected_sp+")");
								}
							}
							else
							{
								ResultSet rs = st.executeQuery("select * from fact_table where pokaz = "+pokaz_id+" and year ="+year+" and data_type = 0");
								if (rs.next())
								{
									st.executeUpdate("update fact_table set value = "+cell+" where pokaz = "+pokaz_id+" and year ="+year+" and data_type = 0");
								}
								else
								{
									st.executeUpdate("insert into fact_table(year,pokaz,value,data_type) values ("+year+","+pokaz_id+","+cell+", 0 )");
								}
							}
						}
					}
					else
					{
						Statement st = conn.createStatement();
						int pokaz_id = row_pokaz_id.get(row);
						int year = column_year.get(column);
						if (by_year)
						{
							int data_type = year;
//							ResultSet rs = st.executeQuery("select * from fact_table where pokaz = "+pokaz_id+" and year ="+year);
							ResultSet rs = st.executeQuery("select * from fact_table where pokaz = "+pokaz_id+" and year ="+selected_year+" and data_type = "+data_type);
							if (rs.next())
							{
								st.executeUpdate("delete from fact_table where pokaz = "+pokaz_id+" and year ="+selected_year+" and data_type = "+data_type);
							}
						}
						else
						{
							if (selected_sp != -1)
							{
//								int data_type = year;
								ResultSet rs = st.executeQuery("select * from fact_table where pokaz = "+pokaz_id+" and year ="+year+" and data_type = "+selected_sp);
								if (rs.next())
								{
									st.executeUpdate("delete from fact_table where pokaz = "+pokaz_id+" and year ="+year+" and data_type = "+selected_sp);
								}
							}
							else
							{
								ResultSet rs = st.executeQuery("select * from fact_table where pokaz = "+pokaz_id+" and year ="+year+" and data_type = 0");
								if (rs.next())
								{
									st.executeUpdate("delete from fact_table where pokaz "+pokaz_id+" and year ="+year+" and data_type = 0");
								}
							}
						}
					}
				} catch (SQLException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				}
				
				fireTableDataChanged();
			}

			public boolean isCellEditable(int rowIndex, int columnIndex) {
				if ((columnIndex == 0)||(not_editable_row.contains(rowIndex)))
					return false;
				return true;
			}
		}

		public Explorer_for_selenga() throws SQLException {
//			super(); 
//			m_PreprocessPanel.setInstances(inst)
			frame.setSize(1300, 700);
			frame.addWindowListener(new WindowAdapter() {
				public void windowClosing(WindowEvent e) {
					System.exit(0);
				}
			});
			Vector<String> columnNames = new Vector<String>();
			by_district.setSelected(true);
			by_district.addActionListener(this);
			by_year.addActionListener(this);
			by_sp.addActionListener(this);
			columnNames.add("Год");
			columnNames.add("Название показателя");
			columnNames.add("Значение");
			select_data = new JPanel();
			button_panel.setLayout(new GridLayout(1, 3, 5, 5));
			button_panel.add(check_all);
			button_panel.add(add_pokaz_button);			
			button_panel.add(delete_pokaz_button);			
			button_panel.add(show);
			check_all.addActionListener(this);
			show.addActionListener(this);
			add_pokaz_button.addActionListener(this);
			delete_pokaz_button.addActionListener(this);
			add_year.addActionListener(this);
			load_for_analyze.addActionListener(this);
			select_data.setLayout(new BorderLayout());
			JPanel option_selection = new JPanel();
			option_selection.setLayout(new BorderLayout());
			JPanel main_option_selection = new JPanel();
			show.setEnabled(false);
			add_pokaz_button.setEnabled(true);
			delete_pokaz_button.setEnabled(true);
			main_option_selection.setLayout(new BorderLayout());
			show_data_type.setBorder(BorderFactory
					.createTitledBorder("Выбрать данные по:"));
			show_data_type.setLayout(new GridLayout(1,3,5,5));
			ButtonGroup select_data_type = new ButtonGroup();
			by_year.setText("По году");
			by_sp.setText("По сельскому поселению");
			by_district.setText("По району в целом");
			select_data_type.add(by_year);
			select_data_type.add(by_sp);
			select_data_type.add(by_district);
			show_data_type.add(by_year);
			show_data_type.add(by_sp);
			show_data_type.add(by_district);
			show_year.setBorder(BorderFactory.createTitledBorder("Год"));
			ButtonGroup select_year = new ButtonGroup(), select_sp=new ButtonGroup();
			show_sp.setBorder(BorderFactory.createTitledBorder("Сельское поселение"));
			main_option_selection.add(show_data_type,BorderLayout.NORTH);
			main_option_selection.add(show_year,BorderLayout.CENTER);
			main_option_selection.add(show_sp,BorderLayout.SOUTH);
			option_selection.add(main_option_selection,BorderLayout.NORTH);
			show_group_pokaz = new JPanel();
			option_selection.add(show_group_pokaz,BorderLayout.CENTER);
			show_group_pokaz.setBorder(BorderFactory
					.createTitledBorder("Группы показателей"));
			show_pokaz.setBorder(BorderFactory.createTitledBorder("Показатели"));
			show_group_pokaz.setLayout(new GridLayout(4, 3, 5, 5));
			ButtonGroup groups = new ButtonGroup();
			connect();
			stmt = c.createStatement();
			rs = stmt.executeQuery("SELECT * FROM group_pokaz where is_sp=0;");
			while (rs.next()) {
				JRB temp = this.new JRB();
				temp.setText(rs.getString("name"));
				temp.tag = rs.getInt("id");
				groups.add(temp);
				temp.addActionListener(this);
				show_group_pokaz.add(temp, BorderLayout.NORTH);
			}
			rs.close();
			select_data.add(option_selection, BorderLayout.NORTH);
			select_data.add(show_pokaz, BorderLayout.CENTER);
			select_data.add(button_panel, BorderLayout.SOUTH);

			TabbedPane.addTab("Выбор данных", null, select_data, "");
			TabbedPane.addTab("Ввод и редактирование данных", null, edit_data, "");
			TabbedPane.addTab(m_PreprocessPanel.getTabTitle(), null,
			        m_PreprocessPanel, m_PreprocessPanel.getTabTitleToolTip());
			TabbedPane.addTab("Прогнозирование", null,
			        forecast, "");
			TabbedPane.setEnabledAt(TabbedPane.getTabCount()-1, false);
			 String[] tabs = ExplorerDefaults.getTabs();
//			for (int i = 0; i < m_Panels.size(); i++) {
//				m_TabbedPane.add((Component)m_Panels.get(i));
//			}			
			 Hashtable<String, HashSet> tabOptions = new Hashtable<String, HashSet>();
			    for (int i = 0; i < tabs.length; i++) {
			      try {
			        // determine classname and additional options
			        String[] optionsStr = tabs[i].split(":");
			        String classname = optionsStr[0];
			        if (PluginManager.isInDisabledList(classname)) {
			          continue;
			        }
			        HashSet options = new HashSet();
			        tabOptions.put(classname, options);
			        for (int n = 1; n < optionsStr.length; n++)
			          options.add(optionsStr[n]);

			        // setup panel
			        ExplorerPanel panel = (ExplorerPanel) Class.forName(classname)
			            .newInstance();
			        panel.setExplorer(this);
			        Panels.add(panel);
			        if (panel instanceof LogHandler)
			          ((LogHandler) panel).setLog(m_LogPanel);
			        TabbedPane.addTab(panel.getTabTitle(), null, (JPanel) panel,
			            panel.getTabTitleToolTip());
			        TabbedPane.setEnabledAt(TabbedPane.getTabCount()-1, false);
			      } catch (Exception e) {
			        e.printStackTrace();
			      }
			    }
			
			frame.add(TabbedPane);
			frame.setVisible(true);
			groups.getSelection();
//			m_PreprocessPanel.
			m_PreprocessPanel.addPropertyChangeListener(new PropertyChangeListener() {
			      @Override
			      public void propertyChange(PropertyChangeEvent e) {
			        for (int i = 0; i < Panels.size(); i++) {
			          Panels.get(i).setInstances(m_PreprocessPanel.getInstances());
			          TabbedPane.setEnabledAt(i + 4, true);
			        }
			      }
			    });
		}

		public static void main(String[] args)  {
			// TODO Auto-generated method stub
			try {
				Explorer_for_selenga rrr = new Explorer_for_selenga();
			} catch (SQLException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
		}

		public void change_data_type(ActionEvent arg0)
		{
			selected_pokaz.clear();
			show_sp.removeAll();
			show_year.removeAll();
			show_group_pokaz.removeAll();
			frame.repaint();
			frame.revalidate();
			show.setEnabled(false);
			ButtonGroup groups = new ButtonGroup();
			try {
				if (by_district.isSelected())
				{
					stmt = c.createStatement();
					rs = stmt.executeQuery("SELECT * FROM group_pokaz where is_sp=0;");
					while (rs.next()) {
						JRB temp = this.new JRB();
						temp.setText(rs.getString("name"));
						temp.tag = rs.getInt("id");
						groups.add(temp);
						temp.addActionListener(this);
						show_group_pokaz.add(temp, BorderLayout.NORTH);
					}
					rs.close();
					frame.repaint();
					frame.revalidate();
				} 
			}
			catch (SQLException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
			if (by_sp.isSelected())
			{
				ButtonGroup temp_bg = new ButtonGroup();
				try {
					stmt=c.createStatement();
					rs = stmt.executeQuery("SELECT * FROM data_type where id > 1");
					show_sp.setLayout(new GridLayout(2,8,5,5));
					while (rs.next())
					{
						JRB_sp temp = this.new JRB_sp();
						temp.setText(rs.getString("name"));
						temp_bg.add(temp);
						temp.tag = rs.getInt("id");
						sp_id_name.put(rs.getInt("id"), rs.getString("name"));
						temp.addActionListener(this);
						show_sp.add(temp);
						show_sp.setVisible(true);
					}
					stmt=c.createStatement();
					rs = stmt.executeQuery("SELECT year FROM fact_table group by year order by year");
					show_sp.setLayout(new GridLayout(2,8,5,5));
					while (rs.next())
					{
						JCB_year temp = this.new JCB_year();
						temp.setText(rs.getString("year"));
						temp.tag = rs.getInt("year");
						temp.addActionListener(this);
						show_year.add(temp);
						show_year.setVisible(true);
					}
					stmt = c.createStatement();
					rs = stmt.executeQuery("SELECT * FROM group_pokaz where is_sp=1;");
					while (rs.next()) {
						JRB temp = this.new JRB();
						temp.setText(rs.getString("name"));
						temp.tag = rs.getInt("id");
						groups.add(temp);
						temp.addActionListener(this);
						show_group_pokaz.add(temp, BorderLayout.NORTH);
					}
					rs.close();
					frame.repaint();
					frame.revalidate();
					rs.close();
				} catch (SQLException e) {
					e.printStackTrace();
				}
				return;
			}
			if (by_year.isSelected())
			{
				ButtonGroup temp_bg = new ButtonGroup();
				try {
					stmt=c.createStatement();
					rs = stmt.executeQuery("SELECT year FROM fact_table group by year order by year");
					show_sp.setLayout(new GridLayout(2,8,5,5));
					while (rs.next())
					{
						JRB_year temp = this.new JRB_year();
						temp.setText(rs.getString("year"));
						temp.tag = rs.getInt("year");
						temp_bg.add(temp);
						
						temp.addActionListener(this);
						show_year.add(temp);
						show_year.setVisible(true);
					}
					stmt=c.createStatement();
					rs = stmt.executeQuery("SELECT * FROM data_type where id > 1");
					show_sp.setLayout(new GridLayout(2,8,5,5));
					while (rs.next())
					{
						JCB_sp temp = this.new JCB_sp();
						temp.setText(rs.getString("name"));
						temp.tag = rs.getInt("id");
						temp.addActionListener(this);
						sp_id_name.put(rs.getInt("id"), rs.getString("name"));
						show_sp.add(temp);
						show_sp.setVisible(true);
					}
					stmt = c.createStatement();
					rs = stmt.executeQuery("SELECT * FROM group_pokaz where is_sp=1;");
					while (rs.next()) {
						JRB temp = this.new JRB();
						temp.setText(rs.getString("name"));
						temp.tag = rs.getInt("id");
						groups.add(temp);
						temp.addActionListener(this);
						show_group_pokaz.add(temp, BorderLayout.NORTH);
					}
					rs.close();
					frame.repaint();
					frame.revalidate();
					rs.close();
				} catch (SQLException e) {
					e.printStackTrace();
				}
				return;
			}
		
		}
		
		public void show_button_click(ActionEvent arg0)
		{

			model=new DatabaseTableModel();
			model.conn=c;
			edit_table = new JTable(model);	
			 final JPopupMenu popupMenu = new JPopupMenu();
	          JMenuItem setvalueitem = new JMenuItem("Выбрать для прогноза");
	          setvalueitem.addActionListener(new ActionListener() {
	              @Override
	              public void actionPerformed(ActionEvent e) {
	                 int sel = edit_table.getSelectedRow();
	                 ArrayList<Double> data=new ArrayList();
//	                 model.row_pokaz_id.get(sel);
	                 if (model.not_editable_row.contains(sel)||model.by_year)
	                	 return;
	                 forecast.curPokaz.setText("Прогнозируемый показатель:"+(String)(model.getValueAt(sel, 0)));
	                 
	                 for (int j = 1; j < model.getColumnCount(); j++) {
							try{
								if (!(model.getValueAt(sel, j)==null) && (model.getValueAt(sel, j) instanceof String))
								{
									data.add(Double.valueOf((String)model.getValueAt(sel, j)));
								}
								else
								{
									if (!(model.getValueAt(sel, j)==null) && (model.getValueAt(sel, j) instanceof Double))
									{
										data.add((Double)model.getValueAt(sel, j));
									}
								}
								} catch (NumberFormatException err)
								{
								}
							}
	                 forecast.data = data;
	                 TabbedPane.setEnabledAt(3, true);
	              }
	          });
	          popupMenu.add(setvalueitem);
	          edit_table.setComponentPopupMenu(popupMenu);
            model.addColumn("Показатель");
            if (by_district.isSelected())
            {
				try {
					stmt=c.createStatement();
					model.selected_sp = -1;
					model.selected_year = -1;
					Integer []sel =selected_pokaz.toArray(new Integer [0]);
					String base_query="SELECT * FROM fact_table where";
					for (int i = 0; i < sel.length; i++) {
						base_query+=" pokaz="+sel[i]+" or";
					}
					String base_query2="SELECT p.id, p.name, p.group_pokaz_id, mu.name as mu_name FROM pokazateli p LEFT JOIN measurement_units mu ON p.measurement_units_id = mu.id where";
					for (int i = 0; i < sel.length; i++) {
						base_query2+=" p.id="+sel[i]+" or";
					}
					base_query=base_query.substring(0, base_query.length()-2);
					base_query2=base_query2.substring(0, base_query2.length()-2);
					String group_query="select year from ("+base_query+") bb group by bb.year order by year";
					rs = stmt.executeQuery(group_query);
					while (rs.next())
					{
						model.addColumn(Integer.toString(rs.getInt("year")));
						model.column_year.put(model.getColumnCount()-1, rs.getInt("year"));
					}
					group_query="select gp.name from ("+base_query2+") p " +
							"LEFT JOIN group_pokaz gp " +
							"ON p.group_pokaz_id = gp.id " +
							"group by gp.name order by gp.name";
					ResultSet subrs; 
					rs=stmt.executeQuery(group_query);
					while(rs.next())
					{
						String cur_group = rs.getString("name");
						Vector<Object> temp_dat = new Vector();
						Statement stmt2 = c.createStatement();
						temp_dat.add(cur_group);
						for (int i = 1; i < model.getColumnCount(); i++) {
							temp_dat.add("*");
						}
						model.addRow(temp_dat);
//							model.
						model.not_editable_row.add(model.getRowCount()-1);
						subrs=stmt2.executeQuery("select p.name, p.id, p.mu_name from ("+base_query2+") p " +
								"LEFT JOIN group_pokaz gp " +
								"ON p.group_pokaz_id = gp.id " +
								"where gp.name =\'"+cur_group+"\' "+
								"group by p.name, p.id, p.mu_name " +
								"order by p.name");
						while(subrs.next())
						{
							int pokaz_id = subrs.getInt("id");
							Statement stmt3 = c.createStatement();
							String pokaz_name = subrs.getString("name");
							String mu = subrs.getString("mu_name");
							String sub_group_query = "SELECT * from ("+base_query+") bb where bb.pokaz="+pokaz_id;
							ResultSet subsubrs = stmt3.executeQuery(sub_group_query);
							Vector<Object> temp_data = new Vector();
							temp_data.setSize(model.getColumnCount());
							temp_data.set(0, "    "+pokaz_name+", "+mu);
							for (int i = 1; i < temp_data.size(); i++) {
								temp_data.set(i, "");
							}
							while (subsubrs.next())
							{
								int year=subsubrs.getInt("year");
								for (int j = 1; j < model.getColumnCount(); j++) {
									if (model.column_year.get(j) == year)
									{
										temp_data.set(j,subsubrs.getDouble("value"));
									}
								}
							}
							model.addRow(temp_data);
							model.row_pokaz_id.put(model.getRowCount()-1, pokaz_id);
							subsubrs.close();
						}
				
						subrs.close();
					}
					rs.close();
				} catch (SQLException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				}
				edit_data.removeAll();
				edit_data.setLayout(new BorderLayout());
				edit_data.add(new JScrollPane(edit_table),BorderLayout.CENTER);
				edit_buttons.add(add_year);
				edit_buttons.add(load_for_analyze);
				edit_data.add(edit_buttons,BorderLayout.SOUTH);
				edit_data.repaint();
				frame.repaint();
				frame.revalidate();
				return;
            }	
            
            
            if (by_year.isSelected())
            {
            	try {
					stmt=c.createStatement();
					model.by_year = true;
					model.selected_year = selected_year;
					Integer []sel =selected_pokaz.toArray(new Integer [0]);
					String base_query="SELECT * FROM fact_table where year = "+selected_year+" and (";
					for (int i = 0; i < sel.length; i++) {
						base_query+=" pokaz="+sel[i]+" or";
					}
					String base_query2="SELECT p.id, p.name, p.group_pokaz_id, mu.name as mu_name FROM pokazateli p LEFT JOIN measurement_units mu ON p.measurement_units_id = mu.id where";
					for (int i = 0; i < sel.length; i++) {
						base_query2+=" p.id="+sel[i]+" or";
					}
					base_query2=base_query2.substring(0, base_query2.length()-2);
					Integer []sel_sp = selected_sps.toArray(new Integer[0]);
					base_query=base_query.substring(0, base_query.length()-2);
					base_query+=") and (";							
					for (int i = 0; i < sel_sp.length; i++) {
						base_query+=" data_type="+sel_sp[i]+" or";
						model.addColumn(sp_id_name.get(sel_sp[i]));
						model.column_year.put(model.getColumnCount()-1, sel_sp[i]);
					}
					base_query=base_query.substring(0, base_query.length()-2);
					base_query+=")";
					String group_query="select gp.name from ("+base_query2+") p " +
							"LEFT JOIN group_pokaz gp " +
							"ON p.group_pokaz_id = gp.id " +
							"group by gp.name order by gp.name";
					ResultSet subrs; 
					rs=stmt.executeQuery(group_query);
					while(rs.next())
					{
						String cur_group = rs.getString("name");
						Vector<Object> temp_dat = new Vector();
						Statement stmt2 = c.createStatement();
						temp_dat.add(cur_group);
						for (int i = 1; i < model.getColumnCount(); i++) {
							temp_dat.add("*");
						}
						model.addRow(temp_dat);
//							model.
						model.not_editable_row.add(model.getRowCount()-1);
						subrs=stmt2.executeQuery("select p.name, p.id, p.mu_name from ("+base_query2+") p " +
								"LEFT JOIN group_pokaz gp " +
								"ON p.group_pokaz_id = gp.id " +
								"where gp.name =\'"+cur_group+"\' "+
								"group by p.name, p.id, p.mu_name " +
								"order by p.name");
						while(subrs.next())
						{
							int pokaz_id = subrs.getInt("id");
							Statement stmt3 = c.createStatement();
							String pokaz_name = subrs.getString("name");
							String mu = subrs.getString("mu_name");
							String sub_group_query = "SELECT * from ("+base_query+") bb where bb.pokaz="+pokaz_id;
							ResultSet subsubrs = stmt3.executeQuery(sub_group_query);
							Vector<Object> temp_data = new Vector();
							temp_data.setSize(model.getColumnCount());
							temp_data.set(0, "    "+pokaz_name+", "+mu);
							for (int i = 1; i < temp_data.size(); i++) {
								temp_data.set(i, "");
							}
							while (subsubrs.next())
							{
								int year=subsubrs.getInt("data_type");
								for (int j = 1; j < model.getColumnCount(); j++) {
									if (model.column_year.get(j) == year)
									{
										temp_data.set(j,subsubrs.getDouble("value"));
									}
								}
							}
							model.addRow(temp_data);
							model.row_pokaz_id.put(model.getRowCount()-1, pokaz_id);
							subsubrs.close();
						}
				
						subrs.close();
					}
					rs.close();
				} catch (SQLException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				}
				edit_data.removeAll();
				edit_data.setLayout(new BorderLayout());
				edit_data.add(new JScrollPane(edit_table),BorderLayout.CENTER);
//				edit_buttons.add(add_year);
				edit_buttons.add(load_for_analyze);
				edit_data.add(edit_buttons,BorderLayout.SOUTH);
				edit_data.repaint();
				frame.repaint();
				frame.revalidate();
            	return;
            }
            
            
            if (by_sp.isSelected())
            {
				try {
					stmt=c.createStatement();
					model.by_year = false;
					model.selected_sp = selected_sp;
					Integer []sel =selected_pokaz.toArray(new Integer [0]);
					String base_query="SELECT * FROM fact_table where data_type = "+selected_sp+" and (";
					for (int i = 0; i < sel.length; i++) {
						base_query+=" pokaz="+sel[i]+" or";
					}
					String base_query2="SELECT p.id, p.name, p.group_pokaz_id, mu.name as mu_name FROM pokazateli p LEFT JOIN measurement_units mu ON p.measurement_units_id = mu.id where";
					for (int i = 0; i < sel.length; i++) {
						base_query2+=" p.id="+sel[i]+" or";
					}
					base_query2=base_query2.substring(0, base_query2.length()-2);
					base_query=base_query.substring(0, base_query.length()-2);
					base_query+=")";
					Integer []sel_year =selected_years.toArray(new Integer [0]);
					Arrays.sort(sel_year);
//					String group_query="select year from ("+base_query+") bb group by bb.year order by year";
//					rs = stmt.executeQuery(group_query);
//					while (rs.next())
//					{
					for (int i = 0; i < sel_year.length; i++) {
						model.addColumn(Integer.toString(sel_year[i]));
						model.column_year.put(model.getColumnCount()-1, sel_year[i]);
					}
//					}
					String group_query="select gp.name from ("+base_query2+") p " +
							"LEFT JOIN group_pokaz gp " +
							"ON p.group_pokaz_id = gp.id " +
							"group by gp.name order by gp.name";
					ResultSet subrs; 
					rs=stmt.executeQuery(group_query);
					while(rs.next())
					{
						String cur_group = rs.getString("name");
						Vector<Object> temp_dat = new Vector();
						Statement stmt2 = c.createStatement();
						temp_dat.add(cur_group);
						for (int i = 1; i < model.getColumnCount(); i++) {
							temp_dat.add("*");
						}
						model.addRow(temp_dat);
//							model.
						model.not_editable_row.add(model.getRowCount()-1);
						subrs=stmt2.executeQuery("select p.name, p.id, p.mu_name from ("+base_query2+") p " +
								"LEFT JOIN group_pokaz gp " +
								"ON p.group_pokaz_id = gp.id " +
								"where gp.name =\'"+cur_group+"\' "+
								"group by p.name, p.id, p.mu_name " +
								"order by p.name");
						while(subrs.next())
						{
							int pokaz_id = subrs.getInt("id");
							Statement stmt3 = c.createStatement();
							String pokaz_name = subrs.getString("name");
							String mu = subrs.getString("mu_name");
							String sub_group_query = "SELECT * from ("+base_query+") bb where bb.pokaz="+pokaz_id;
							ResultSet subsubrs = stmt3.executeQuery(sub_group_query);
							Vector<Object> temp_data = new Vector();
							temp_data.setSize(model.getColumnCount());
							temp_data.set(0, "    "+pokaz_name+", "+mu);
							for (int i = 1; i < temp_data.size(); i++) {
								temp_data.set(i, "");
							}
							while (subsubrs.next())
							{
								int year=subsubrs.getInt("year");
								for (int j = 1; j < model.getColumnCount(); j++) {
									if (model.column_year.get(j) == year)
									{
										temp_data.set(j,subsubrs.getDouble("value"));
									}
								}
							}
							model.addRow(temp_data);
							model.row_pokaz_id.put(model.getRowCount()-1, pokaz_id);
							subsubrs.close();
						}
				
						subrs.close();
					}
					rs.close();
				} catch (SQLException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				}
				edit_data.removeAll();
				edit_data.setLayout(new BorderLayout());
				edit_data.add(new JScrollPane(edit_table),BorderLayout.CENTER);
				edit_buttons.add(add_year);
				edit_buttons.add(load_for_analyze);
				edit_data.add(edit_buttons,BorderLayout.SOUTH);
				edit_data.repaint();
				frame.repaint();
				frame.revalidate();
				return;
            }
		
		}
		
		public void load_for_analyze_click(ActionEvent arg0)
		{

			ArrayList<Attribute> attribs = new ArrayList();
			if (model.by_year)
			{
				List<String> values = new ArrayList();
//				java.util.List<E>
				for (int i = 1; i < model.getColumnCount(); i++) {
					values.add(model.getColumnName(i));
				}
//				new att
				attribs.add(new Attribute("Сельское поселение",values));
				String header= "";
				int kolattr = 1;
				for (int i = 0; i < model.getRowCount(); i++) {
					if (model.not_editable_row.contains(i))
					{
						header =(String) model.getValueAt(i, 0);
					}
					else
					{
						String name = header+" : "+(String) model.getValueAt(i, 0);
						attribs.add(new Attribute(name));
						kolattr++;
					}
				}
				Instances data = new Instances("Данные по сельским поселениям за "+model.selected_year+" год", attribs, 100);
				for (int i = 1; i < model.getColumnCount(); i++) {
					int tempi = 1;
					Instance temp = new DenseInstance(kolattr);
					temp.setValue((Attribute)attribs.get(0), model.getColumnName(i));
					for (int j = 1; j < model.getRowCount(); j++) {
						if (!model.not_editable_row.contains(j))
						{
							try{
							if (!(model.getValueAt(j, i)==null) && (model.getValueAt(j, i) instanceof String))
							{
								temp.setValue(tempi, Double.valueOf((String)model.getValueAt(j, i)));
								tempi++;
							}
							else
							{
								if (!(model.getValueAt(j, i)==null) && (model.getValueAt(j, i) instanceof Double))
								{
									temp.setValue(tempi, (Double)model.getValueAt(j, i));
									tempi++;
								}
								else
								{
									temp.setMissing(tempi);
									tempi++;
								}
							}
							} catch (NumberFormatException e)
							{
								temp.setMissing(tempi);
								tempi++;
							}
						}
					}
					data.add(temp);
				}
				m_PreprocessPanel.setInstances(data);						
			}
			else
			{
				if (model.selected_sp == -1)
				{
					List<String> values = new ArrayList();
//					java.util.List<E>
					for (int i = 1; i < model.getColumnCount(); i++) {
						values.add(model.getColumnName(i));
					}
//					new att
					attribs.add(new Attribute("Год",values));
					String header= "";
					int kolattr = 1;
					for (int i = 0; i < model.getRowCount(); i++) {
						if (model.not_editable_row.contains(i))
						{
							header =(String) model.getValueAt(i, 0);
						}
						else
						{
							String name = header+" : "+(String) model.getValueAt(i, 0);
							attribs.add(new Attribute(name));
							kolattr++;
						}
					}
					Instances data = new Instances("Данные по Селенгинскому району", attribs, 100);
					for (int i = 1; i < model.getColumnCount(); i++) {
						int tempi = 1;
						Instance temp = new DenseInstance(kolattr);
						temp.setValue((Attribute)attribs.get(0), model.getColumnName(i));
						for (int j = 1; j < model.getRowCount(); j++) {
							if (!model.not_editable_row.contains(j))
							{
								try{
								if (!(model.getValueAt(j, i)==null) && (model.getValueAt(j, i) instanceof String))
								{
									temp.setValue(tempi, Double.valueOf((String)model.getValueAt(j, i)));
									tempi++;
								}
								else
								{
									if (!(model.getValueAt(j, i)==null) && (model.getValueAt(j, i) instanceof Double))
									{
										temp.setValue(tempi, (Double)model.getValueAt(j, i));
										tempi++;
									}
									else
									{
										temp.setMissing(tempi);
										tempi++;
									}
								}
								} catch (NumberFormatException e)
								{
									temp.setMissing(tempi);
									tempi++;
								}
							}
						}
						data.add(temp);
					}
					m_PreprocessPanel.setInstances(data);
				}
				else
				{
					List<String> values = new ArrayList();
//					java.util.List<E>
					for (int i = 1; i < model.getColumnCount(); i++) {
						values.add(model.getColumnName(i));
					}
//					new att
					attribs.add(new Attribute("Год",values));
					String header= "";
					int kolattr = 1;
					for (int i = 0; i < model.getRowCount(); i++) {
						if (model.not_editable_row.contains(i))
						{
							header =(String) model.getValueAt(i, 0);
						}
						else
						{
							String name = header+" : "+(String) model.getValueAt(i, 0);
							attribs.add(new Attribute(name));
							kolattr++;
						}
					}
					Instances data = new Instances("Данные по сельскому поселению "+sp_id_name.get(model.selected_sp), attribs, 100);
					for (int i = 1; i < model.getColumnCount(); i++) {
						int tempi = 1;
						Instance temp = new DenseInstance(kolattr);
						temp.setValue((Attribute)attribs.get(0), model.getColumnName(i));
						for (int j = 1; j < model.getRowCount(); j++) {
							if (!model.not_editable_row.contains(j))
							{
								try{
								if (!(model.getValueAt(j, i)==null) && (model.getValueAt(j, i) instanceof String))
								{
									temp.setValue(tempi, Double.valueOf((String)model.getValueAt(j, i)));
									tempi++;
								}
								else
								{
									if (!(model.getValueAt(j, i)==null) && (model.getValueAt(j, i) instanceof Double))
									{
										temp.setValue(tempi, (Double)model.getValueAt(j, i));
										tempi++;
									}
									else
									{
										temp.setMissing(tempi);
										tempi++;
									}
								}
								} catch (NumberFormatException e)
								{
									temp.setMissing(tempi);
									tempi++;
								}
							}
						}
						data.add(temp);
					}
					m_PreprocessPanel.setInstances(data);
				}
			}
			return;		
		}
		
		@Override
		public void actionPerformed(ActionEvent arg0) {
				if (arg0.getSource().getClass().getName().equals("mainpak.Explorer_for_selenga$JRB_data_type"))
				{
					change_data_type(arg0);
					return;
				}			
				
				if (arg0.getSource().getClass().getName().equals("mainpak.Explorer_for_selenga$JRB_year"))
				{
					selected_year = ((JRB_year)arg0.getSource()).tag;
					return;
				}
				
				if (arg0.getSource().getClass().getName().equals("mainpak.Explorer_for_selenga$JCB_year"))
				{
					int c = ((JCB_year)arg0.getSource()).tag;
					if (((JCB_year)arg0.getSource()).isSelected() )
					{
						selected_years.add(c);
					}
					else
					{
//						selected_years.
						selected_years.remove(c);
					}
					return;
				}

				if (arg0.getSource().getClass().getName().equals("mainpak.Explorer_for_selenga$JRB_sp"))
				{
					selected_sp = ((JRB_sp)arg0.getSource()).tag;
					return;
				}
				
				if (arg0.getSource().getClass().getName().equals("mainpak.Explorer_for_selenga$JCB_sp"))
				{
					int c = ((JCB_sp)arg0.getSource()).tag;
					if (((JCB_sp)arg0.getSource()).isSelected() )
					{
						selected_sps.add(c);
					}
					else
					{
						selected_sps.remove(c);
					}
					return;
				}
				
				if (arg0.getSource().getClass().getName().equals("mainpak.Explorer_for_selenga$JRB"))
				{
					System.out.println("wow!"+((JRB)arg0.getSource()).tag);
					try {
						stmt=c.createStatement();
						rs = stmt.executeQuery("SELECT * FROM pokazateli where group_pokaz_id ="+((JRB)arg0.getSource()).tag);
						show_pokaz.removeAll();
						show_pokaz.setLayout(new GridLayout(4,3,5,5));
						while (rs.next())
						{
							JCB temp = this.new JCB();
							temp.setText(rs.getString("name"));
							temp.tag = rs.getInt("id");
							if (selected_pokaz.contains(temp.tag))
							{
								temp.setSelected(true);
							}
							temp.addActionListener(this);
							show_pokaz.add(temp);
						}
						frame.repaint();
						frame.revalidate();
						rs.close();
					} catch (SQLException e) {
						// TODO Auto-generated catch block
						e.printStackTrace();
					}
					return;
				}
				
				
				
				
				if (arg0.getSource().getClass().getName().equals("mainpak.Explorer_for_selenga$JCB"))
				{
					int c = ((JCB)arg0.getSource()).tag;
					if (((JCB)arg0.getSource()).isSelected() )
					{
						selected_pokaz.add(c);
					}
					else
					{
						selected_pokaz.remove(c);
					}
					if (selected_pokaz.size()>0)
					{
						show.setEnabled(true);
					}
					else
						show.setEnabled(false);
					return;
				}
				
				
				if (arg0.getSource()==check_all)
				{
//					System.out.println(arg0.getSource().getClass().getName());
					for (int i = 0; i < show_pokaz.getComponentCount(); i++) {
						((JCB)show_pokaz.getComponent(i)).setSelected(true);
						int c = ((JCB)show_pokaz.getComponent(i)).tag;
						selected_pokaz.add(c);
					}
					if (selected_pokaz.size()>0)
					{
						show.setEnabled(true);
					}
					else
						show.setEnabled(false);
					return;
				}	
				
				
				
				if (arg0.getSource()==show)
				{
					show_button_click(arg0);
					return;
				}
				
				
				if (arg0.getSource()==add_year)
				{
					String new_year = JOptionPane.showInputDialog("Введите год:");
					if ((new_year!=null)&&(!new_year.isEmpty()))
					{
						int year=Integer.parseInt(new_year);
						boolean flag=true;
						for (int i = 0; i < model.getColumnCount(); i++) {
							if (model.getColumnName(i).equals(new_year))
							{
								flag=false;
								break;
							}
						}
						if (flag)
						{
						 model.addColumn(new_year);
						 model.column_year.put(model.getColumnCount()-1,year);
						}
					}		
					return;
				}
				
				
				if (arg0.getSource()==load_for_analyze)
				{
					load_for_analyze_click(arg0);
					return;
				}
				
				if (arg0.getSource()==add_pokaz_button)
				{
					try {
						add_pokaz_form = new Add_pokaz(c);
					} catch (SQLException e) {
						// TODO Auto-generated catch block
						e.printStackTrace();
					}
					return;
				}
				
				if (arg0.getSource()==delete_pokaz_button)
				{
					try {
						Integer []sel =selected_pokaz.toArray(new Integer [0]);
					} catch (SQLException e) {
						// TODO Auto-generated catch block
						e.printStackTrace();
					}
					return;
				}
				
				System.out.println(arg0.getSource().getClass().getName());
				return;
		}
	}



