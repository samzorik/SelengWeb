
import org.openqa.selenium.By; 
import org.openqa.selenium.WebElement;

import org.openqa.selenium.JavascriptExecutor; 

import org.openqa.selenium.WebDriver; 

import org.openqa.selenium.WebDriverException; 
import org.openqa.selenium.firefox.FirefoxDriver;

import java.io.BufferedWriter;
import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashSet;
import java.util.List;
import java.util.Set; 

/**
 * Creates and Handles a New window  *
 */ 
public class WebWindow { 

          private static WebDriver driver; 
          private String handle; 
          private String name; 
          private String parentHandle; 
          public static String handleHost;
          private static int instanceCount = 0; 
          /**
          * Creates a new window for given web driver
          * @param parent WebDriver instance
          * @param url   Initial url to load
          * @return new WebWindow
          */ 
          public WebWindow(WebDriver parent, String url) { 
          this.driver = parent; 
               parentHandle = parent.getWindowHandle(); 
          name = createUniqueName(); 
                   handle = createWindow(url); 
                   //Switch to that window and load the url to wait 
                   switchToWindow().get(url); 
          } 
          public String getWindowHandle(){ 
                   return handle; 
          } 
          public String getParentHandle(){ 
                   return parentHandle; 
          } 
          public void close(){ 
                   switchToWindow().close(); 
                   handle = ""; 
                   //Switch back to the parent window 
                   driver.switchTo().window(parentHandle); 
          } 
          private static String createUniqueName() { 
                   return "a_Web_Window_" + instanceCount++; 
          } 
          public WebDriver switchToWindow(){ 
                   checkForClosed(); 
                   return driver.switchTo().window(handle); 
          } 
          public WebDriver switchToParent(){ 
                   checkForClosed(); 
                   return driver.switchTo().window(parentHandle); 
          } 
          private String createWindow(String url){ 
                   //Record old handles 
                   Set oldHandles = driver.getWindowHandles(); 
                   parentHandle = driver.getWindowHandle(); 
                   //Inject an anchor element 
                   ((JavascriptExecutor) driver). 
                             executeScript( 
                                      injectAnchorTag(name,url) 
                             ); 
                   //Click on the anchor element 
                   driver.findElement(By.id(name)).click(); 
                   handle = getNewHandle(oldHandles); 
                   return  handle; 
          } 
          private String getNewHandle(Set oldHandles){ 
                   Set<String> newHandles = driver.getWindowHandles(); 
                   newHandles.removeAll(oldHandles); 
                   //Find the new window 
                   for(String handle : newHandles ) 
                   return handle; 
                   return null; 
          } 
          private void checkForClosed(){ 
                   if ( handle  == null || handle.equals("") ) 
throw new WebDriverException("Web Window closed or not initialized"); 

          } 
          private String injectAnchorTag(String id, String url){ 
                   return String.format(  "var anchorTag = document.createElement('a'); " + 
                   "anchorTag.appendChild(document.createTextNode('nwh'));" + 
                   "anchorTag.setAttribute('id', '%s');" + 
                   "anchorTag.setAttribute('href', '%s');" + 
                   "anchorTag.setAttribute('target', '_blank');" + 
                   "anchorTag.setAttribute('style', 'display:block;');" + 
"document.getElementsByTagName('body')[0].appendChild(anchorTag);", 
                   id, url 
                   );
          } 
          
          protected void CreateNewTab(){

              try{

     WebWindow tab2 = new WebWindow(driver, "url"); // “url” - ссылка новой вкладки

            }

            catch (Exception e){

                System.err.println("Couldn't load second page");

            }

         }

        protected void SwitchFromSecondTabToFirst(){

            try{

                driver.switchTo().window(handleHost);

                driver.switchTo().activeElement();

                

            }

            catch (Exception e){

                System.err.println("Couldn't get back to first page");

            }

          }

        protected void SwitchFromFirstPageToSecond(){

            try{

                for (String handle : driver.getWindowHandles()){

                    if (handle!=handleHost){

                        driver.switchTo().window(handle);

                        driver.switchTo().activeElement();

           } // смотрим все вкладки (а их две всего); если і-тая вкладка не равна первой handleHost (инициализированой в пункте (а), тогда переключаемся на нее).

                }

            }

            catch (Exception e){

                System.err.println("Couldn't get to second page");

            }

        }
          
                   public static void main(String[] args) throws InterruptedException, IOException {
                       driver = new FirefoxDriver();
                       
                       String nicework[]={"p8001001","p8001002","p8001003","p8001004","p8001005","p8001006","p8001007","p8006001","p8006008","p8006005","p8006007","p8006003","p8006006","p8006002","p8006004","p8112035","p8112027","p8112014","p8112030","p8112015","p8112016","p8112003","p8112025","p8112001","p8112007","p8112008","p8112021","p8112022","p8112023","p8112004","p8112002","p8112005","p8112006","p8112009","p8112010","p8112011","p8112012","p8123005","p8123015","p8123006","p8123016","p8123007","p8123001","p8123002","p8123003","p8123004","p8123008","p8123009","p8122002","p8122003","p8123010","p8023001","p8123011","p8123017","p8122004","p8122005","p8122006","p8122007","p8122008","p8122009","p8022002","p8022001","p8008015","p8008016","p8008017","p8008018","p8008001","p8008002","p8008003","p8008004","p8008024","p8008007","p8008008","p8008025","p8008011","p8008012","p8008026","p8008019","p8008020","p8008021","p8008022","p8008023","p8008005","p8008006","p8008009","p8008010","p8008013","p8008014","p8012001","p8012005","p8012002","p8012003","p8012004","p8018100","p8018101","p8018108","p8018103","p8018104","p8018106","p8018107","p8018001","p8018002","p8018003","p8018004","p8018005","p8018006","p8018007","p8018008","p8018009","p8018010","p8018011","p8018012","p8018013","p8018014","p8018015","p8018016","p8018017","p8018018","p8018019","p8018020","p8018021","p8019013","p8019014","p8019012","p8019011","p8019001","p8019002","p8019003","p8019004","p8019005","p8019006","p8019007","p8019008","p8019009","p8019010","p8014001","p8015007","p8014006","p8014002","p8014003","p8014004","p8015001","p8015005","p8015002","p8015003","p8015006","p8015004","p8003001","p8003002","p8003003","p8003005","p8003004","p8016001","p8016002","p8016003","p8017001","p8017002","p8017003","p8017004","p8017005","p8017006","p8017007","p8017008","p8017009","p8017015","p8017016","p8017017","p8017018","p8017019","p8017020","p8017021","p8017022","p8017023","p8017010","p8017011","p8017012","p8017013","p8017014","p8055001","p8055002","p8055003","p8005003","p8005004","p8005001","p8005002","p8007010","p8007011","p8007012","p8007013","p8007014","p8007015","p8007016","p8007017","p8007018","p8007001","p8007023","p8007019","p8007022","p8007020","p8007002","p8007021","p8101003","p8101004","p8101020","p8101021","p8101005","p8101006","p8101007","p8101008","p8101022","p8101009","p8101010","p8101011","p8101013","p8101014","p8101001","p8101002","p8101017","p8101012","p8201001","p8201002","p8010001","p8010002","p8011011","p8011010","p8011002","p8011001","p8043001","p8043002","p8002011","p8002006","p8201003","p8201004","p8201005","p8002001","p8002002","p8002003","p8002004","p8002005","p8002010","p8020001","p8020002","p8020003","p8020004","p8045001","p8045002","p8045003","p8045004","p8045005","p8045006","p8009001","p8109001","p8109002","p8013018","p8013001","p8013002","p8013003","p8013004","p8013012","p8013013","p8013014","p8013015","p8013016","p8013017","p8013005","p8013006","p8013007","p8013010","p8013011","p8042001","p8042002","p8042003","p8042004","p8042005","p8042006","p8042007","p8042008","p8042009","p8042010","p8042011","p8042012","p8042013","p8042014","p8042015","p8042016","p8042017","p8042018","p8042019","p8042020","p8042021","p8042022","p8042023","p8042024","p8042025","p8111001","p8111002","p8111003","p8111004","p8111005","p8111006","p8111007","p8111008","p8112060","p8112062","p8112072","p8111009","p8111040","p8111041","p8111042","p8111043","p8111044","p8111015","p8111016","p8111017","p8111018","p8111019","p8111020","p8111021","p8111022","p8111023","p8111024","p8111025","p8111026","p8111027","p8111028","p8111029","p8111030","p8111045","p8111031","p8111032","p8111033","p8111034","p8111046","p8111047","p8111010","p8111011","p8111012","p8111013","p8111014","p8111048","p8111049","p8111050","p8111051","p8111053","p8111055","p8111056","p8111054","p8111063","p8111057","p8111058","p8111059","p8111060","p8111061","p8111062","p8111064","p8111065","p8111066","p8111067","p8111068","p8111069","p8111070","p8111052","p8111071","p8111072","p8155057","p8211001","p8014007","p8155054","p8211002","p8155040","p8155055","p8155056","p8215003","p8155053","p8155052","p8112024","p8106007","p8106006","p8106001","p8106002","p8155001","p8106003","p8106004","p8106005","p8155002","p8155027","p8155028","p8155029","p8155030","p8155003","p8155004","p8155005","p8155006","p8155031","p8155032","p8155007","p8155008","p8155009","p8155033","p8109003","p8212002","p8212003","p8212001","p8213001","p8213002","p8213003","p8213004","p8213005","p8114003","p8114004","p8155035","p8112020","p8114001","p8155010","p8155036","p8114002","p8155012","p8114005","p8114006","p8114007","p8213007","p8213008","p8155011","p8114008","p8215001","p8215002","p8155016","p8155017","p8155014","p8155015","p8212005","p8155013","p8155018","p8211003","p8216001","p8155022","p8155023","p8155024","p8155025","p8312027","p8155037","p8155038","p8155039","p8155041","p8155042","p8155043","p8155044","p8155045","p8155047","p8155048","p8155049","p8155050","p8155051","p8313015","p8313016","p8313017","p8155026","p8313001","p8155019","p8155020","p8155021"};
                       String work_with_data[]={"p8001001","p8001002","p8001003","p8001004","p8001005","p8001006","p8001007","p8006001","p8006005","p8006007","p8006003","p8006006","p8006002","p8112027","p8112014","p8112015","p8112016","p8112003","p8112001","p8112007","p8112008","p8112021","p8112022","p8112023","p8112004","p8112009","p8123005","p8123015","p8123006","p8123016","p8123007","p8123001","p8123002","p8123003","p8123004","p8123008","p8123009","p8122002","p8122003","p8123010","p8023001","p8123011","p8123017","p8122006","p8022002","p8022001","p8008015","p8008018","p8008001","p8008002","p8008003","p8008004","p8008024","p8008007","p8008008","p8008025","p8008011","p8008012","p8008026","p8008019","p8008020","p8008021","p8008022","p8008023","p8008005","p8008006","p8008009","p8008010","p8008013","p8008014","p8012001","p8012005","p8012002","p8012003","p8012004","p8018100","p8018101","p8018108","p8018103","p8018104","p8018106","p8018107","p8018001","p8018002","p8018003","p8018004","p8018005","p8018006","p8018007","p8018008","p8018009","p8018010","p8018011","p8018012","p8018013","p8018014","p8018015","p8018016","p8018017","p8018018","p8018019","p8018020","p8018021","p8019013","p8019014","p8019012","p8019011","p8019001","p8019002","p8019003","p8019004","p8019005","p8019006","p8019007","p8019008","p8019009","p8019010","p8014001","p8014006","p8014002","p8014003","p8014004","p8015001","p8015005","p8015002","p8015003","p8015006","p8015004","p8003001","p8003002","p8003003","p8003005","p8003004","p8016001","p8016002","p8016003","p8017001","p8017002","p8017003","p8017004","p8017005","p8017006","p8017007","p8017008","p8017009","p8017015","p8017016","p8017017","p8017021","p8017022","p8017023","p8017010","p8017011","p8017012","p8017013","p8017014","p8055001","p8055002","p8055003","p8005003","p8005004","p8007010","p8007011","p8007012","p8007013","p8007014","p8007015","p8007016","p8007017","p8007018","p8007001","p8007023","p8007019","p8007022","p8007020","p8007002","p8007021","p8101003","p8101004","p8101020","p8101005","p8101006","p8101007","p8101008","p8101022","p8101009","p8101010","p8101011","p8101013","p8101014","p8101001","p8101002","p8101017","p8101012","p8201001","p8201002","p8010001","p8010002","p8011011","p8011010","p8011002","p8011001","p8043001","p8043002","p8002011","p8002006","p8201003","p8201004","p8201005","p8002001","p8002002","p8002003","p8002004","p8002005","p8002010","p8020001","p8020002","p8020003","p8020004","p8045001","p8045002","p8045003","p8045004","p8045005","p8045006","p8009001","p8109001","p8109002","p8013018","p8013001","p8013002","p8013003","p8013004","p8013012","p8013013","p8013014","p8013015","p8013017","p8013005","p8013006","p8013007","p8013010","p8013011","p8042001","p8042002","p8042003","p8042004","p8042005","p8042006","p8042007","p8042008","p8042009","p8042010","p8042011","p8042012","p8042013","p8042014","p8042015","p8042016","p8042017","p8042018","p8042019","p8042020","p8042021","p8042022","p8042023","p8042024","p8042025","p8111001","p8111002","p8111003","p8111004","p8111005","p8111006","p8111007","p8111008","p8112060","p8112062","p8112072","p8111009","p8111040","p8111041","p8111042","p8111043","p8111044","p8111015","p8111016","p8111017","p8111018","p8111019","p8111020","p8111021","p8111022","p8111023","p8111024","p8111025","p8111026","p8111027","p8111028","p8111029","p8111030","p8111045","p8111031","p8111032","p8111033","p8111034","p8111046","p8111047","p8111010","p8111011","p8111012","p8111014","p8111048","p8111049","p8111050","p8111051","p8111055","p8111056","p8111054","p8111063","p8111057","p8111058","p8111059","p8111061","p8111062","p8111064","p8111065","p8111066","p8111067","p8111068","p8111069","p8111070","p8111052","p8111071","p8111072","p8155057","p8211001","p8014007","p8155054","p8211002","p8155040","p8155055","p8155056","p8215003","p8112024","p8106007","p8106006","p8106001","p8106002","p8155001","p8106003","p8106004","p8106005","p8155002","p8155028","p8155029","p8155030","p8155003","p8155004","p8155005","p8155006","p8155031","p8155032","p8155007","p8155008","p8155009","p8155033","p8109003","p8212001","p8213001","p8213002","p8213003","p8213004","p8213005","p8114003","p8114004","p8155035","p8112020","p8155010","p8155036","p8114005","p8114006","p8114007","p8213007","p8213008","p8155011","p8114008","p8215001","p8215002","p8155016","p8155017","p8155014","p8155015","p8212005","p8155013","p8155018","p8211003","p8216001","p8155022","p8155023","p8155024","p8155025","p8312027","p8155037","p8155038","p8155039","p8155041","p8155042","p8155043","p8155044","p8155045","p8155047","p8155048","p8155049","p8155050","p8155051","p8313015","p8313017","p8155026","p8313001","p8155019","p8155020","p8155021"};
//                       File truewrite=new File("C:\\post\\Выгрузка показателей РБ.txt");
//                       BufferedWriter writer = new BufferedWriter(
//                               new FileWriter(
//                                 truewrite,true));	
                       driver.get("http://medframe.burmiac.ru/SD/default.aspx");
//                       driver.switchTo().window(arg0);
                       Set<String> oldWindowsSet = driver.getWindowHandles();
                       handleHost = driver.getWindowHandle(); 
               		String mainwindowhandle=oldWindowsSet.iterator().next();
               		WebElement check2=driver.findElement(By.id("Main1_Login1_tbxPass"));
               		check2.sendKeys("sz665");
//               		check.
//                       WebElement element5 = driver.findElement(By.name("p8001001"));
//                       Actions builder = new Actions(driver);
//                       builder.
//                       builder.moveToElement(element5).click(element5);
                       Thread.sleep(250);
//                       Action mouseoverAndClick = builder.build();
//                       mouseoverAndClick.perform();
                       JavascriptExecutor js = (JavascriptExecutor) driver;
//                       js.
                       js.executeScript("document.getElementById(\"Main1_Login1_ddlUser\").value = \"   52\"");
                       WebElement submit=driver.findElement(By.id("Main1_Login1_btnEnter"));
                       submit.click();
                       Thread.sleep(300);
                       WebElement showfilter=driver.findElement(By.id("Main1_CallList1_btnShowFilter"));
                       showfilter.click();
                       Thread.sleep(500);
                       submit=driver.findElement(By.id("Main1_CallList1_ddl_OpenClose"));
                       submit=driver.findElement(By.id("Main1_CallList1_btnFilter"));
                       js.executeScript("document.getElementById(\"Main1_CallList1_ddl_OpenClose\").selectedIndex=1");
                       submit.click();
                       WebElement next=null;
                       Set<Integer> indexes=new HashSet(Arrays.asList(new Integer[] { 1, 3, 4, 5 , 9, 10 , 11, 13 }));
//                       indexes.
                       boolean was=false;
                       boolean flag=false;
                       String tecid="1",temp_id="";
                       for (int i = 0; true; i++) {
						if (driver.getPageSource().indexOf("Main1_CallList1_ibtnPageNext2")>-1)
                  	        next=driver.findElement(By.id("Main1_CallList1_ibtnPageNext2"));
						else
							continue;
                  	        if	(next!=null)
                  	        next.click();
                  	        Thread.sleep(1000);
                  	        WebElement tex=driver.findElement(By.id("Main1_CallList1_lblPageindex2"));
                  	        tecid=tex.getText();
//                       js.executeScript("javascript:WebForm_DoPostBackWithOptions(new WebForm_PostBackOptions(\"Main1$CallList1$ibtnPageNext2\", \"\", true, \"\", \"\", false, false))");
					} 
                  	        
                       if (driver.getPageSource().indexOf("Main1_CallList1_ibtnPageNext2")>-1)
                       {
                       	next=driver.findElement(By.id("Main1_CallList1_ibtnPageNext2"));
                       	WebElement tec_index=driver.findElement(By.id("Main1_CallList1_lblPageindex2"));
                       	tecid=tec_index.getText();
                       	was=true;
                       }
                       else
                       next=null;
                       do 
                       {
                       	WebElement table=driver.findElement(By.id("Main1_CallList1_dtgrdCalls"));
                       	List<WebElement> rows=table.findElements(By.tagName("tr"));
               	        for (WebElement webElement : rows) {
               	        	int counter=0;
               	        	List<WebElement> id=webElement.findElements(By.tagName("a"));
               	        	int num;
               	        	if (!id.isEmpty())
               	        	{
               	        		System.out.print(id.get(0).getText()+"|");
               	        		num=Integer.parseInt(id.get(0).getText());
               	        		counter++;
               	        	}
               	        	else
               	        		continue;
               				List<WebElement> cells=webElement.findElements(By.tagName("span"));
               				for (WebElement webElement2 : cells) {
               					if (indexes.contains(counter))
               					System.out.print(webElement2.getText().replace("\n", " ")+"|");
               					counter++;
               				}
               				WebWindow ww = new WebWindow(driver, "http://medframe.burmiac.ru/SD/default.aspx?call="+num);
               				Thread.sleep(500);
               				WebElement answers=ww.driver.findElement(By.id("Main1_Call1_dtgrdCallHistory"));
               				List<WebElement> spans=answers.findElements(By.tagName("span"));
               				List<String> ans=new ArrayList();
               				ans.add("Нет ни одного комментария");               				
               				for (WebElement webElement2 : spans) {
               					if (webElement2.getAttribute("id").indexOf("CallMsgText")>-1)
               					{
               					    ans.add(webElement2.getText().replace("\n", " "));
               					}								
							}
               				System.out.print(ans.get(ans.size()-1));
               				ww.close();
               				ww.SwitchFromSecondTabToFirst();
               				
//               				ww.
               				System.out.println();
               			}
               	        flag=true;
	               	     for (int i = 0; i < 8; i++) {
	                  	   Thread.sleep(100);
	                  	   if (driver.getPageSource().indexOf("Main1_CallList1_lblPageindex2")>-1)
	                  	   {
	                  		WebElement tec_index=driver.findElement(By.id("Main1_CallList1_lblPageindex2"));
	                       	temp_id=tec_index.getText();
	                  	   }
	                  	   else
								continue;
	                  	   if (!tecid.equals(temp_id))
	                  	   {
	                  		   tecid=temp_id;
	                  		   flag=false;
	                  		   break;
	                  	   }
							if (driver.getPageSource().indexOf("Main1_CallList1_ibtnPageNext2")>-1)
	                	        next=driver.findElement(By.id("Main1_CallList1_ibtnPageNext2"));
							else
								continue;
                	        if	(next!=null)
                	        next.click();
	               	     }
               	        Thread.sleep(500);
                       }while (!flag);                       
                   }  
}
